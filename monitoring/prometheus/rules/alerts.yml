# Prometheus Alerting Rules
# =========================
# Alert rules for loan approval API monitoring

groups:
  # ==========================================================================
  # API Health Alerts
  # ==========================================================================
  - name: api_health
    interval: 30s
    rules:
      # API Down Alert
      - alert: APIDown
        expr: up{job="loan-api"} == 0
        for: 1m
        labels:
          severity: critical
          service: loan-api
        annotations:
          summary: "Loan API is down"
          description: "Loan API instance {{ $labels.instance }} has been down for more than 1 minute."

      # High Error Rate
      - alert: HighErrorRate
        expr: |
          (
            sum(rate(loan_api_requests_by_status{status=~"5.."}[5m]))
            /
            sum(rate(loan_api_requests_total[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: warning
          service: loan-api
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (> 5%) for the last 5 minutes."

      # Critical Error Rate
      - alert: CriticalErrorRate
        expr: |
          (
            sum(rate(loan_api_requests_by_status{status=~"5.."}[5m]))
            /
            sum(rate(loan_api_requests_total[5m]))
          ) > 0.10
        for: 2m
        labels:
          severity: critical
          service: loan-api
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (> 10%) for the last 2 minutes."

  # ==========================================================================
  # Performance Alerts
  # ==========================================================================
  - name: api_performance
    interval: 30s
    rules:
      # High Latency Warning
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95, 
            sum(rate(loan_api_request_duration_seconds_bucket[5m])) by (le)
          ) > 1.0
        for: 5m
        labels:
          severity: warning
          service: loan-api
        annotations:
          summary: "High API latency detected"
          description: "95th percentile latency is {{ $value | humanizeDuration }} (> 1s)."

      # Critical Latency
      - alert: CriticalLatency
        expr: |
          histogram_quantile(0.99, 
            sum(rate(loan_api_request_duration_seconds_bucket[5m])) by (le)
          ) > 5.0
        for: 2m
        labels:
          severity: critical
          service: loan-api
        annotations:
          summary: "Critical API latency detected"
          description: "99th percentile latency is {{ $value | humanizeDuration }} (> 5s)."

      # High Request Rate (potential DDoS)
      - alert: HighRequestRate
        expr: sum(rate(loan_api_requests_total[1m])) > 1000
        for: 5m
        labels:
          severity: warning
          service: loan-api
        annotations:
          summary: "Unusually high request rate"
          description: "Request rate is {{ $value | humanize }} req/s, which may indicate unusual traffic."

  # ==========================================================================
  # Resource Alerts
  # ==========================================================================
  - name: resource_usage
    interval: 30s
    rules:
      # High CPU Usage
      - alert: HighCPUUsage
        expr: loan_api_cpu_percent > 80
        for: 5m
        labels:
          severity: warning
          service: loan-api
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}."

      # Critical CPU Usage
      - alert: CriticalCPUUsage
        expr: loan_api_cpu_percent > 95
        for: 2m
        labels:
          severity: critical
          service: loan-api
        annotations:
          summary: "Critical CPU usage"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}. Immediate attention required."

      # High Memory Usage
      - alert: HighMemoryUsage
        expr: loan_api_memory_percent > 80
        for: 5m
        labels:
          severity: warning
          service: loan-api
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }}."

      # Critical Memory Usage
      - alert: CriticalMemoryUsage
        expr: loan_api_memory_percent > 95
        for: 2m
        labels:
          severity: critical
          service: loan-api
        annotations:
          summary: "Critical memory usage"
          description: "Memory usage is {{ $value }}% on {{ $labels.instance }}. Risk of OOM."

  # ==========================================================================
  # Database Alerts
  # ==========================================================================
  - name: database_health
    interval: 30s
    rules:
      # Database Connection Failed
      - alert: DatabaseConnectionFailed
        expr: loan_api_database_status == 0
        for: 1m
        labels:
          severity: critical
          service: postgresql
        annotations:
          summary: "Database connection failed"
          description: "API cannot connect to PostgreSQL database."

      # Slow Database Queries
      - alert: SlowDatabaseQueries
        expr: loan_api_database_latency_seconds > 0.5
        for: 5m
        labels:
          severity: warning
          service: postgresql
        annotations:
          summary: "Slow database queries"
          description: "Database query latency is {{ $value | humanizeDuration }}."

  # ==========================================================================
  # Infrastructure Alerts
  # ==========================================================================
  - name: infrastructure
    interval: 60s
    rules:
      # Low Disk Space
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: warning
          service: infrastructure
        annotations:
          summary: "Low disk space"
          description: "Disk space is below 10% on {{ $labels.mountpoint }}."

      # Container Restart
      - alert: ContainerRestarting
        expr: increase(container_restart_count[15m]) > 3
        for: 5m
        labels:
          severity: warning
          service: docker
        annotations:
          summary: "Container restarting frequently"
          description: "Container {{ $labels.name }} has restarted {{ $value }} times in the last 15 minutes."
